<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ad Player</title>
<style>
  :root{ --bg:#000; --fg:#e5e7eb; --muted:#94a3b8; --accent:#3a86ff; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  .stage{ position:fixed; inset:0; display:grid; place-items:center; background:#000; }
  .hidden{ display:none !important; }
  img, video{ max-width:100vw; max-height:100vh; object-fit:contain; background:#000; }
  .overlay{ position:fixed; left:12px; bottom:12px; font-size:13px; color:var(--muted); }
  .chrome{ position:fixed; right:12px; top:12px; display:flex; gap:6px; }
  .btn{ background:#0b1220; border:1px solid #1f2937; color:#e5e7eb; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
  .btn:hover{ border-color:#3a86ff }
  .error{ position:fixed; top:12px; left:12px; color:#fca5a5; font-size:13px; }
</style>
</head>
<body>
  <div class="stage">
    <img id="img" class="hidden" alt="ad"/>
    <video id="vid" class="hidden" playsinline muted autoplay controlslist="nodownload noplaybackrate" disablepictureinpicture></video>
  </div>
  <div id="err" class="error"></div>
  <div class="overlay" id="meta"></div>
  <div class="chrome">
    <button id="prev" class="btn">Prev Display</button>
    <div id="lab" class="btn" style="pointer-events:none"></div>
    <button id="next" class="btn">Next Display</button>
  </div>

<script>
(async function(){
  const urlParams = new URLSearchParams(location.search);
  let display = parseInt(urlParams.get("display") || "1", 10);
  if (![1,2,3].includes(display)) display = 1;

  const FEED = (d) => `/api/player/feed?display=${d}`;
  const img = document.getElementById("img");
  const vid = document.getElementById("vid");
  const meta = document.getElementById("meta");
  const err = document.getElementById("err");
  const lab = document.getElementById("lab");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");

  let playlist = [];
  let idx = 0, feedURL = FEED(display);

  const setLab = () => lab.textContent = `Display ${display}`;

  prevBtn.onclick = async () => { display = display === 1 ? 3 : (display-1); setLab(); feedURL = FEED(display); await loadFeed(); idx = 0; };
  nextBtn.onclick = async () => { display = display === 3 ? 1 : (display+1); setLab(); feedURL = FEED(display); await loadFeed(); idx = 0; };

  setLab();

  async function loadFeed(){
    try{
      err.textContent = "";
      const r = await fetch(feedURL, { cache: "no-store" });
      if(!r.ok) throw new Error("Feed HTTP " + r.status);
      const data = await r.json();
      playlist = Array.isArray(data.playlist) ? data.playlist : [];
      if (playlist.length === 0) err.textContent = "No active approved ads.";
    }catch(e){
      err.textContent = "Failed to load feed: " + (e.message || e);
    }
  }

  function showMeta(item){
    const from = item.scheduled_from ? new Date(item.scheduled_from).toLocaleString() : "—";
    const to   = item.scheduled_to   ? new Date(item.scheduled_to).toLocaleString()   : "—";
    meta.textContent = `D${display} • ${item.title || ""} • ${from} → ${to}`;
  }

  function hideBoth(){
    img.classList.add("hidden");
    vid.classList.add("hidden");
    vid.pause();
    vid.removeAttribute("src");
    vid.load();
  }

  async function playLoop(){
    if (playlist.length === 0) {
      await new Promise(r => setTimeout(r, 6000));
      await loadFeed();
      return playLoop();
    }

    const item = playlist[idx % playlist.length];
    idx++;

    showMeta(item);
    hideBoth();

    if (item.type === "image"){
      img.src = item.url;
      img.classList.remove("hidden");
      const dur = Math.max(3, Number(item.duration || 10)) * 1000;
      await new Promise(r => setTimeout(r, dur));
    } else {
      vid.src = item.url;
      vid.currentTime = 0;
      vid.classList.remove("hidden");
      try { await vid.play(); } catch { vid.muted = true; try{ await vid.play(); }catch{} }
      await new Promise(r => {
        let to = setTimeout(()=>r(), 120000);
        const done = () => { clearTimeout(to); r(); };
        vid.onended = done;
        vid.onerror = done;
      });
    }

    if (idx % playlist.length === 0) await loadFeed();
    return playLoop();
  }

  await loadFeed();
  playLoop();

  document.body.style.cursor = "none";
})();
</script>
</body>
</html>
