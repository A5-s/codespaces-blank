<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ad Player</title>
<style>
  :root{ --bg:#000; --fg:#e5e7eb; --muted:#94a3b8; --accent:#3a86ff; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  .stage{ position:fixed; inset:0; display:grid; place-items:center; background:#000; }
  .hidden{ display:none !important; }
  img, video{ max-width:100vw; max-height:100vh; object-fit:contain; background:#000; }
  .overlay{ position:fixed; left:16px; bottom:16px; font-size:14px; color:var(--muted); }
  .error{ position:fixed; top:16px; left:16px; color:#fca5a5; font-size:14px; }
</style>
</head>
<body>
  <div class="stage">
    <img id="img" class="hidden" alt="ad"/>
    <video id="vid" class="hidden" playsinline muted autoplay controlslist="nodownload noplaybackrate" disablepictureinpicture></video>
  </div>
  <div id="err" class="error"></div>
  <div class="overlay" id="meta"></div>

<script>
(async function(){
  const FEED_URL = "/api/player/feed";
  const img = document.getElementById("img");
  const vid = document.getElementById("vid");
  const meta = document.getElementById("meta");
  const err = document.getElementById("err");

  let playlist = [];
  let idx = 0;

  async function loadFeed(){
    try{
      err.textContent = "";
      const r = await fetch(FEED_URL, { cache: "no-store" });
      if(!r.ok) throw new Error("Feed HTTP " + r.status);
      const data = await r.json();
      playlist = Array.isArray(data.playlist) ? data.playlist : [];
      if (playlist.length === 0) {
        err.textContent = "No active approved ads.";
      }
      idx = 0;
    }catch(e){
      err.textContent = "Failed to load feed: " + (e.message || e);
    }
  }

  function showMeta(item){
    const from = item.scheduled_from ? new Date(item.scheduled_from).toLocaleString() : "—";
    const to   = item.scheduled_to   ? new Date(item.scheduled_to).toLocaleString()   : "—";
    meta.textContent = `${item.title || ""} • ${from} → ${to}`;
  }

  function hideBoth(){
    img.classList.add("hidden");
    vid.classList.add("hidden");
    vid.pause();
    vid.removeAttribute("src");
    vid.load();
  }

  async function playLoop(){
    if (playlist.length === 0) {
      await new Promise(r => setTimeout(r, 8000));
      await loadFeed();
      return playLoop();
    }

    const item = playlist[idx % playlist.length];
    idx++;

    showMeta(item);
    hideBoth();

    if (item.type === "image"){
      img.src = item.url;
      img.classList.remove("hidden");
      const dur = Math.max(3, Number(item.duration || 10)) * 1000;
      await new Promise(r => setTimeout(r, dur));
    } else {
      vid.src = item.url;
      vid.currentTime = 0;
      vid.classList.remove("hidden");
      // attempt autoplay; if blocked, mute+play
      try { await vid.play(); } catch { vid.muted = true; try{ await vid.play(); }catch{} }
      await new Promise(r => {
        let to = setTimeout(()=>r(), 120000); // safety 2 min cap
        const done = () => { clearTimeout(to); r(); };
        vid.onended = done;
        vid.onerror = done;
      });
    }

    // Periodically refresh the feed (e.g. every full cycle)
    if (idx % playlist.length === 0) {
      await loadFeed();
    }
    return playLoop();
  }

  await loadFeed();
  playLoop();

  // Make sure the cursor is hidden on Pi (also install 'unclutter' there)
  document.body.style.cursor = "none";
})();
</script>
</body>
</html>